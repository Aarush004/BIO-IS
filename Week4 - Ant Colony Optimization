import numpy as np
import random

def create_distance_matrix(cities):
    num_cities = len(cities)
    dist_matrix = np.zeros((num_cities, num_cities))
    for i in range(num_cities):
        for j in range(i + 1, num_cities):
            distance = np.sqrt((cities[i][0] - cities[j][0])**2 + (cities[i][1] - cities[j][1])**2)
            dist_matrix[i, j] = dist_matrix[j, i] = distance
    return dist_matrix

def calculate_tour_length(tour, dist_matrix):
    length = 0
    num_cities = len(tour)
    for i in range(num_cities):
        city_a = tour[i]
        city_b = tour[(i + 1) % num_cities]
        length += dist_matrix[city_a, city_b]
    return length

def aco_tsp_solver(cities, num_ants=10, max_iterations=100, alpha=1.0, beta=5.0, rho=0.5, initial_pheromone=1.0):
    num_cities = len(cities)
    dist_matrix = create_distance_matrix(cities)
    eta_matrix = 1.0 / (dist_matrix + np.finfo(float).eps)
    np.fill_diagonal(eta_matrix, 0)
    pheromone_matrix = np.full((num_cities, num_cities), initial_pheromone)
    best_tour = None
    best_length = float('inf')
    history = []
    print(f"Starting ACO for {num_cities} cities with {num_ants} ants...")
    for iteration in range(max_iterations):
        all_tours = []
        all_lengths = []
        for ant in range(num_ants):
            start_city = random.randint(0, num_cities - 1)
            tour = [start_city]
            visited = {start_city}
            for _ in range(num_cities - 1):
                current_city = tour[-1]
                unvisited_cities = [c for c in range(num_cities) if c not in visited]
                if not unvisited_cities:
                    break
                probabilities = []
                denominator = 0.0
                for next_city in unvisited_cities:
                    tau = pheromone_matrix[current_city, next_city] ** alpha
                    eta = eta_matrix[current_city, next_city] ** beta
                    numerator = tau * eta
                    probabilities.append((next_city, numerator))
                    denominator += numerator
                if denominator == 0:
                    next_city = random.choice(unvisited_cities)
                else:
                    prob_values = [p[1] / denominator for p in probabilities]
                    next_city = random.choices([p[0] for p in probabilities], weights=prob_values, k=1)[0]
                tour.append(next_city)
                visited.add(next_city)
            tour_length = calculate_tour_length(tour, dist_matrix)
            all_tours.append(tour)
            all_lengths.append(tour_length)
            if tour_length < best_length:
                best_length = tour_length
                best_tour = tour
        history.append(best_length)
        pheromone_matrix = (1 - rho) * pheromone_matrix
        if best_tour is not None:
            delta_tau = 1.0 / best_length
            for i in range(num_cities):
                city_a = best_tour[i]
                city_b = best_tour[(i + 1) % num_cities]
                pheromone_matrix[city_a, city_b] += delta_tau
                pheromone_matrix[city_b, city_a] += delta_tau
        print(f"Iteration {iteration+1:3d} | Best Length: {best_length:.4f} | Best Tour: {best_tour}")
    return best_tour, best_length, history

def run_aco_example():
    random.seed(42)
    np.random.seed(42)
    cities = [(random.uniform(0, 10), random.uniform(0, 10)) for _ in range(10)]
    best_tour, best_length, history = aco_tsp_solver(
        cities,
        num_ants=20,
        max_iterations=50,
        alpha=1.0,
        beta=5.0,
        rho=0.1
    )
    print("\n--- Final Results ---")
    print(f"Cities: {cities}")
    print(f"Best Tour (City Indices): {best_tour}")
    print(f"Best Tour Length: {best_length:.4f}")

if __name__ == '__main__':
    run_aco_example()
